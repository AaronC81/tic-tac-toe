<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Tic-Tac-Toe</title>
</head>
<body>
    <!-- The HTML string generated by `generateUi` goes in here. -->
    <div id="app"></div>

    <!-- Load the socket library -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Set up a socket connection so that the UI refreshes whenever there's
        // a state change
        const socket = io();
        socket.on("state change", state => {
            console.log(state);
            const newHTML = generateUi(state);
            document.getElementById("app").innerHTML = newHTML;
        });

        // If we're told to reconnect, do so 
        socket.on("reset", () => {
            socket.disconnect(false);
            window.location.href = window.location.href; // refresh
        })

        // This function generates an HTML string based on a game state sent
        // from the server.
        function generateUi(newState) {
            var finalString = "";

            // Write a reset button
            finalString += `<button onclick='socket.emit("reset")'>Reset everything</button>`;

            // If there's a winner, write it
            if (newState.winner == "?") {
                finalString += "<h1>Game over; nobody won.</h1>";
            } else if (newState.winner != null) {
                finalString += `<h1>${newState.winner} wins!<h1>`;
            }

            // Figure out which player we've been assigned
            if (newState.playerO == socket.id) {
                var thisPlayer = "O";
            } else if (newState.playerX == socket.id) {
                var thisPlayer = "X";
            } else {
                var thisPlayer = "S";
            }

            // Write the current player
            finalString += `<h1>You are ${thisPlayer}</h1>`;

            // Write whose turn it is
            if (newState.whoseTurn == null) {
                // If the game hasn't started, write a button which starts it
                finalString += "<h2>The game hasn't started yet.</h2>";
                finalString +=
                    `<button onclick='socket.emit("start game")'>Start</button><br>`;
            } else {
                finalString += `<h2>It is ${newState.whoseTurn}'s turn.</h2>`;
            }

            // Draw the board
            // Warning: This is *horrible* code
            for (var row = 0; row < 3; row++) {
                for (var col = 0; col < 3; col++) {
                    // For each cell of the grid, draw a fixed-size button
                    // It's disabled if there's already something in it, if
                    // if it's not our turn, or if there's a winner
                    const shouldButtonBeDisabled =
                        newState.board[row][col] != null
                        || newState.whoseTurn != thisPlayer
                        || newState.winner != null;

                    finalString += `<button
                        ${shouldButtonBeDisabled ? "disabled" : ""}
                        style="width: 50px; height: 50px;"
                        onclick='socket.emit("make move", [${row}, ${col}])'>
                        ${newState.board[row][col] || "."}
                        </button>
                    `;
                }

                // Add a line break after each row
                finalString += "<br>";
            }

            return finalString;
        }
    </script>
</body>
</html>